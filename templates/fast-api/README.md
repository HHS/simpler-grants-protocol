# CommonGrants FastAPI Implementation

A template for implementing a CommonGrants API using Python and FastAPI.

## Pre-requisites

1. The TypeSpec compiler and CommonGrants API are installed globally: `npm install -g @common-grants/core @typespec/compiler`
2. Python 3.11 or greater is installed globally: `python --version`
3. Poetry is installed globally: `poetry --version`

## Quickstart

1. Create a new directory for your project: `mkdir fast-api && cd fast-api`
2. Set up the project using this template and follow the instructions: `cg init --template fast-api`
3. Install the python project dependencies: `make install`
4. Run the tests: `make test`
5. Run the local development server: `make dev`

## Setup

After initializing your project, you'll need to customize the configuration values in `src/common_grants/constants.py` to match your organization's requirements.

### Constants Configuration

The `constants.py` file contains essential configuration values that should be customized for your specific implementation:

- **`ORGANIZATION_DOMAIN`**: Your organization's domain name (e.g., "mycompany.com")
- **`OPPORTUNITY_NAMESPACE`**: A deterministic UUID namespace generated from your domain for consistent ID generation

### Customization Steps

1. **Edit the domain**: Open `src/common_grants/constants.py` and replace `"example.com"` with your actual organization domain
2. **Verify namespace generation**: The `OPPORTUNITY_NAMESPACE` will automatically update when you change the domain
3. **Test the configuration**: Run `make test` to ensure your changes work correctly

**Example:**
```python
# Before customization
ORGANIZATION_DOMAIN = "example.com"

# After customization
ORGANIZATION_DOMAIN = "mycompany.com"
```

**Why this matters:**
- The namespace ensures that all opportunity IDs generated by your API are unique and consistent
- Using your organization's domain prevents ID conflicts with other implementations
- This is especially important when integrating with external systems or when multiple organizations use the CommonGrants Protocol

## Commands

The Makefile exposes the following commands:

| Command               | Description                                 |
| --------------------- | ------------------------------------------- |
| `make install`        | Installs the python dependencies and API    |
| `make test`           | Runs the unit test suite and test coverage  |
| `make test-coverage`  | Runs tests with coverage report             |
| `make format`         | Runs formatting with black                  |
| `make lint`           | Runs linting with ruff                      |
| `make check-format`   | Checks formatting without making changes    |
| `make check-lint`     | Checks linting without making changes      |
| `make check-domain`   | Runs domain config validation               |
| `make check-spec`     | Validates the OpenAPI specification         |
| `make check-types`    | Runs type checking with pyright             |
| `make checks`         | Runs linting, formatting, and type checking |
| `make dev`            | Runs the development server                 |
| `make gen-openapi`    | Generates the OpenAPI specification         |

## Project Structure

```
├── pyproject.toml          # Python project configuration and dependencies
├── poetry.lock             # Locked versions of dependencies
├── Makefile                # Development workflow commands
├── README.md               # Project documentation
├── openapi.yaml            # Generated OpenAPI specification
│
├── src/
│   └── common_grants/              # Main package directory
│       ├── api.py                  # FastAPI application setup and config
│       ├── constants.py            # Application constants and configuration
│       ├── routes/                 # API route handlers and endpoints
│       │   └── opportunities.py    # Opportunity-related endpoints
│       │
│       ├── schemas/                # Data models and schema definitions
│       │   └── __init__.py         # Schema exports (imports from Python SDK)
│       │
│       ├── services/               # Business logic and data operations
│       │   ├── opportunity.py      # Opportunity-related operations
│       │   └── utils.py            # Shared utility functions
│       │
│       └── scripts/                # Utility scripts
│           ├── generate_openapi.py # OpenAPI specification generator
│           └── check_domain.sh     # Domain validation script
│
└── tests/                  # Test suite
    └── common_grants/      # Tests matching package structure
        └── routes/         # Route handler tests

## Dependencies

This template depends on the CommonGrants Python SDK (`common-grants-sdk`) for core field types and models:

- **Field Types**: `Money`, `Event`, `CustomField`, `SystemMetadata`, etc.
- **Core Models**: `OpportunityBase`, `OppFunding`, `OppStatus`, `OppTimeline`

The template extends these with FastAPI-specific schemas for:
- API responses and error handling
- Query filters and pagination
- Request/response models
- Search functionality
